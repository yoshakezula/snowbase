/*! snowbase 2013-04-16 */
(function(){var t={}.hasOwnProperty,e=function(e,r){function a(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return a.prototype=r.prototype,e.prototype=new a,e.__super__=r.prototype,e};$(function(){var t,r,a,n,s,o,i,p,l,h,c,u,d,m,g,y,f,v;return r=function(t){function r(){return c=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.idAttribute="_id",r}(Backbone.Model),p=function(t){function r(){return u=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.idAttribute="_id",r}(Backbone.Model),l=function(t){function r(){return d=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.model=p,r.prototype.url="api/snow-days",r.prototype.initialize=function(){return this._resortMap={},this.on("add",this._addModelToMaps),this.on("sync",this._addAllModelsToMaps)},r.prototype._addModelToMaps=function(t){var e,r,a;return r=t.get("resort_name"),e=new Date(t.get("date")),a=t.get("season_name"),this._resortMap[r]||(this._resortMap[r]={}),this._resortMap[r][a]||(this._resortMap[r][a]={}),this._resortMap[r][a][t.get("date_string")]=t},r.prototype._addAllModelsToMaps=function(){var t=this;return this._resortMap={},_.each(this.models,function(e){return t._addModelToMaps(e)})},r}(Backbone.Collection),a=function(t){function a(){return m=a.__super__.constructor.apply(this,arguments)}return e(a,t),a.prototype.model=r,a.prototype.url="/api/resorts",a}(Backbone.Collection),h=new l,i=new a,o=function(t){function r(){return g=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.className="resort-list-item",r.prototype.events={click:"clickHandler"},r.prototype.clickHandler=function(){return Backbone.Events.trigger("resortClicked",this.model),this.el.addClass("resort-list-item-selected")},r.prototype.render=function(){return this.$el.html(this.model.get("formatted_name")),this},r}(Backbone.View),n=function(t){function r(){return y=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.el=$("#resort-data-pane"),r.prototype.initialize=function(){var t=this;return this.chartData=[],this.listenTo(Backbone.Events,"resortClicked",this.clickHandler),this.paletteStep=-1,this.rgba=$("html").hasClass("rgba"),this.paletteHEX=["#39cc67","#70A5FF","#85B1FF","#99BEFF","#ADCBFF","#C2D8FF","#D6E5FF","#EBF2FF"],this.paletteRGBA=_.map(this.paletteHEX,function(e){return t.colorToRGBA(e).rgba})},r.prototype.colorToRGBA=function(t,e,r){var a,n;return void 0===e&&"string"==typeof t?(t=t.replace(/^\s*#|\s*$/g,""),3===t.length&&t.replace(/(.)/g,"$1$1"),e=parseInt(t.substr(2,2),16),r=parseInt(t.substr(4,2),16),t=parseInt(t.substr(0,2),16),n=Math.min(t,e,r),a=(255-n)/255,{r:t=0|(t-n)/a,g:e=0|(e-n)/a,b:r=0|(r-n)/a,a:a=(0|1e3*a)/1e3,rgba:"rgba("+t+", "+e+", "+r+", "+a+")"}):void 0},r.prototype.getColor=function(){return this.paletteStep+=1,this.rgba?this.paletteRGBA[this.paletteStep]||this.paletteRGBA[this.paletteRGBA.length-1]:this.paletteHEX[this.paletteStep]||this.paletteHEX[this.paletteHEX.length-1]},r.prototype.renderChart=function(){var t,e,r,a,n,s,o,i,p,l,h=this;return this.$(".rickshaw_graph, .legend, .chart-slider").remove(),this.$("#resort-data").html('<div class="rickshaw_graph"></div><div class="legend"></div><div class="chart-slider"></div>'),r=.8034*$(window).width()-40,e=Math.min(500,$(window).height()-90),0!==_.size(this.chartData)?(n=new Rickshaw.Graph({element:this.$(".rickshaw_graph")[0],width:r,height:e,stroke:!0,renderer:this.rgba?"area":"line",series:this.chartData,interpolation:"basis"}),n.renderer.unstack=!0,n.render(),this.$(".rickshaw_graph").addClass("come-in"),i=new Rickshaw.Graph.Legend({graph:n,element:this.$(".legend")[0]}),l=new Rickshaw.Graph.Behavior.Series.Toggle({graph:n,legend:i}),s=new Rickshaw.Graph.Behavior.Series.Highlight({graph:n,legend:i}),a=this.dateMap,p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t=Rickshaw.Class.create(Rickshaw.Graph.HoverDetail,{render:function(t){var e,r,s,o,i,l,h,c,u,d,m,g,y,f,v;return v=_.last(_.sortBy(t.detail,function(t){return t.name})),f=_.sortBy(_.filter(t.detail,function(t){return t.name!==v.name}),function(t){return t.name}),f=f.reverse(),i=new Date(a[v.value.x]),l=p[i.getMonth()]+" "+i.getDate(),d=0,g=9999,m="",y="",e=0,_.each(t.detail,function(t){return e+=t.value.y,t.value.y>d&&(m=t.name,d=t.value.y),g>t.value.y?(y=t.name,g=t.value.y):void 0}),e/=t.detail.length,r=100*(v.value.y/e-1),s=Math.abs(r.toFixed(0))+'% <span class="base-comparison-above-below">'+(0>r?"below":"above")+"</span> average",o='<div class="chart-hover-date">'+l+" Base Depth</div>",o+='<div class="this-season-base"><b>'+v.name+"</b>: "+v.value.y.toFixed(0)+" in.",v.name===m&&(o+=' <span class="highest-base-label">HIGH</span>'),v.name===y&&(o+=' <span class="lowest-base-label">LOW</span>'),o+="</div>",o+='<div class="this-season-base-comparison-stats">'+s+"</div>",_.each(f,function(t){return o+='<div class="past-season-base"><b>'+t.name+"</b>: "+t.value.y.toFixed(0)+" in.",t.name===m&&(o+=' <span class="highest-base-label">HIGH</span>'),t.name===y&&(o+=' <span class="lowest-base-label">LOW</span>'),o+="</div>"}),h=document.createElement("div"),h.className="dot active",c=n.y(v.value.y0+v.value.y),h.style.top=c+"px",h.style.borderColor=v.series.color,this.element.appendChild(h),u=document.createElement("div"),u.className="item active",u.innerHTML=o,this.element.appendChild(u),u.style.top=c-Math.max(0,$(".rickshaw_graph").offset().top+c+$(u).height()-$(window).height())+"px",this.show()}}),o=new t({graph:n}),$(window).off("resize.chart"),$(window).on("resize.chart",function(){return h.renderChart()})):void 0},r.prototype.populateChartData=function(){var t,e,r=this;return this.paletteStep=-1,this.chartData=[],this.dateMap={},e=_.keys(h._resortMap[this.model.get("name")]).sort().reverse(),t={},_.each(e,function(e){return t[e]=r.getColor()}),this.thisSeasonName=_.first(e),_.each(h._resortMap[this.model.get("name")],function(e,a){var n;return n=[],_.each(e,function(t){return n.push({x:t.get("season_day"),y:t.get("base")}),r.dateMap[t.get("season_day")]=t.get("date")}),r.chartData.push({name:a,data:n,color:t[a],stroke:a===r.thisSeasonName?"rgba(255,255,255,0.8)":"rgba(0,0,0,0.25)"})}),this.chartData=_.sortBy(this.chartData,function(t){return t.name})},r.prototype.clickHandler=function(t){var e=this;return this.model=t,this.$("#resort-name").html(this.model.get("formatted_name")+" Base Depth"),this.$("#resort-data").html('<div class="slick-loading-message"><span>L</span><span>O</span><span>A</span><span>D</span><span>I</span><span>N</span><span>G</span></div>'),0===h.models.length?(this.listenTo(h,"sync",function(){return e.populateChartData(),e.renderChart()}),void 0):(this.stopListening(h,"sync"),this.populateChartData(),this.renderChart())},r}(Backbone.View),s=function(t){function r(){return f=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.el=$("#resort-list-search-box"),r.prototype.initialize=function(){return this.$el=$(this.el)},r.prototype.events={keyup:"filterResults"},r.prototype.filterResults=function(){var t;return this.$el.val()&&(t=this.$el.val().trim().toUpperCase()),t?_.each($(".resort-list-item"),function(e){return $(e).text().toUpperCase().indexOf(t)>-1?$(e).removeClass("slide-down"):$(e).addClass("slide-down")}):$(".resort-list-item").removeClass("slide-down")},r}(Backbone.View),t=function(t){function r(){return v=r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.el=$("#app"),r.prototype.initialize=function(){return i.bind("sync",this.render,this),i.fetch(),h.fetch()},r.prototype.appendResort=function(t){var e;return e=new o({model:t}),this.$("#resort-list").append(e.render().el)},r.prototype.appendAllResorts=function(){var t,e=this;return t=_.sortBy(i.models,function(t){return t.get("formatted_name")}),_.each(t,function(t){return e.appendResort(t)})},r.prototype.renderResortDataPane=function(){return this.resortDataPane=new n},r.prototype.initResortSearchBox=function(){return this.resortSearchBox=new s},r.prototype.render=function(){return this.appendAllResorts(),this.initResortSearchBox(),this.renderResortDataPane()},r}(Backbone.View),new t})}).call(this);